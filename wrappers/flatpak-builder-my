#!/bin/bash

BASE_DIR=~/tmp/big/flatpak-builder
mkdir -p "$BASE_DIR"/{state,repo,app}

: "${FLATPAK_BUILDER_REPO="$BASE_DIR/repo"}"
: "${FLATPAK_BUILDER_CACHE="$BASE_DIR/state"}"

FLATPAK_BUILDER_ARGS=()
if [[ ${FLATPAK_BUILDER_KEY+set} ]]; then
	FLATPAK_BUILDER_ARGS=(
		--gpg-sign="$FLATPAK_BUILDER_KEY"
	)
fi

APP_DIR="$(mktemp -d -p ~/tmp/big/flatpak-builder/app)"
cleanup() {
	rm -rf "$app_dir"
}
trap cleanup EXIT

/usr/bin/flatpak-builder \
	--install-deps-from=flathub \
	"${FLATPAK_BUILDER_ARGS[@]}" \
	--ccache \
	--state-dir "$FLATPAK_BUILDER_CACHE" \
	--repo "$FLATPAK_BUILDER_REPO" \
	"$APP_DIR" \
	"$@"
