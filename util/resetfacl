#!/bin/bash -e

set -eo pipefail
shopt -s lastpipe

. lib.sh

tmpdir=""
cleanup() {
	if [[ "$tmp" ]]; then
		rm -rf "$tmp"
		tmp=''
	fi
}
trap cleanup EXIT
tmpdir="$(mktemp -d)"

declare -A DIR_TEMPLATES FILE_TEMPLATES

into_tmpfile() {
	local tmpfile="$(mktemp --tmpdir="$tmpdir")"
	cat >"$tmpfile"
	echo "$tmpfile"
}

path_compute_acl() {
	if ! [[ -e "$file" ]]; then
		die "Bad file: '$file'"
	fi

	parent="${file%/*}"; if [[ $parent == $file ]]; then parent=.; fi
	if ! [[ -d "$parent" ]]; then
		die "Bad parent: '$parent' (file: '$file')"
	fi

	if ! [[ ${DIR_TEMPLATES[$parent]} ]]; then
		sample="$parent/.tmp.$$.d"
		mkdir "$sample"

		DIR_TEMPLATES[$parent]="$(getfacl "$sample" | into_tmpfile)"
		rm -d "$sample"

		sample="$parent/.tmp.$$.f"
		touch "$sample"
		FILE_TEMPLATES[$parent]="$(getfacl "$sample" | into_tmpfile)"
		rm -f "$sample"
	fi
}

path_apply_acl() {
	parent="${file%/*}"; if [[ $parent == $file ]]; then parent=.; fi

	if [[ -d "$file" ]]; then
		template="${DIR_TEMPLATES[$parent]}"
	else
		template="${FILE_TEMPLATES[$parent]}"
	fi

	if ! [[ "$template" ]]; then
		die "Bad template for '$parent' (file: '$file')"
	fi

	if ! setfacl --set-file="$template" "$file"; then
		die "Failed to reset ACLs: '$file'"
	fi
}

case "$1" in
-R|-r)
	shift
	target="$(realpath -qe "$1")"
	cd "$(dirname "$target")"
	file=.
	path_compute_acl  # parent == .
	find "$(basename "$target")" -type d -print0 | parallel -0 --bar -r -N1000 "setfacl --set-file=${DIR_TEMPLATES[.]}"
	find "$(basename "$target")" -not -type d -print0 | parallel -0 --bar -r -N1000 "setfacl --set-file=${FILE_TEMPLATES[.]}"
	;;

-d)
	shift
	cd "$1"
	file=.
	path_compute_acl  # parent == .
	find -mindepth 1 -type d -print0 | parallel -0 --bar -r -N1000 "setfacl --set-file=${DIR_TEMPLATES[.]}"
	find -mindepth 1 -not -type d -print0 | parallel -0 --bar -r -N1000 "setfacl --set-file=${FILE_TEMPLATES[.]}"
	;;
*)
	for file; do
		path_compute_acl "$file"
	done

	for file; do
		path_apply_acl "$file"
	done
	;;
esac

