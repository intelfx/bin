#!/bin/bash

set -eo pipefail
shopt -s lastpipe

ARGV0="${0##*/}"
ARGS=()
COLUMNS=()
REDUCED=0
COLOR=0
PAGING=0

case "$ARGV0" in
zfs-listv) REDUCED=0 ;;
zfs-list)  ;&
zfs-listq) REDUCED=1 ;;
esac

while (( $# )); do
	case "$1" in
	-c|--color) COLOR=1; shift ;;
	-P|--pager) PAGING=1; shift ;;
	-o) COLUMNS+=("$2"); shift 2;;
	-o=*) COLUMNS+=("${1#-o=}"); shift 1;;
	-o*) COLUMNS+=("${1#-o}"); shift 1;;
	-v) REDUCED=0; shift 1;;
	-q) REDUCED=1; shift 1;;
	*) ARGS+=("$1"); shift 1;;
	esac
done

COLUMNS_PRE=(
	"name,volsize,volblocksize,recordsize,lused,used,lrefer,refer,usedds,usedsnap,compressratio,avail"
)
COLUMNS_PRE_REDUCED=(
	"name,used,refer"
)

if (( REDUCED ))
then COLUMNS_PRE=( "${COLUMNS_PRE_REDUCED[@]}" )
fi

COLUMNS=(
	"${COLUMNS_PRE[@]}"
	"${COLUMNS[@]}"
	"mountpoint"
)

IFS=','
ZFS_LIST_CMD=(
	zfs list -o "${COLUMNS[*]}" "${ARGS[@]}"
)
unset IFS

# IFS=','
# exec zfs list -o "${COLUMNS[*]}" "${ARGS[@]}"

if [[ $COLOR == 1 || -t 1 ]] \
&& command -v bat &>/dev/null \
&& bat --list-languages | grep -q -w zfs-list; then
	BAT_CMD=(
		bat --language zfs-list --plain --color=always --paging="$( (( PAGING )) && echo always || echo never )"
	)

	# try not to leave a shell hanging around
	exec "${ZFS_LIST_CMD[@]}" | exec "${BAT_CMD[@]}"
else
	exec "${ZFS_LIST_CMD[@]}"
fi
